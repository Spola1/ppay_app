#!/usr/bin/env python3

from seleniumbase import Driver
import pyotp
import os

def main():
    email = os.environ.get('BYBIT_EMAIL')
    password = os.environ.get('BYBIT_PASSWORD')
    totp_secret = os.environ.get('BYBIT_TOTP_SECRET')

    if not email:
        return

    try:
        driver = Driver(uc=True)
        driver.get("https://bybit.com/login")

        driver.wait_for_element("[name=email]", timeout=30)
        driver.save_screenshot('010_credentials.png')
        driver.find_element("[name=email]").send_keys(email)
        driver.find_element("[name=password]").send_keys(password)
        driver.find_element("xpath", "//button[contains(text(),'Log in')]").click()

        if totp_secret:
            driver.wait_for_element("[title=code]", timeout=30)
            driver.save_screenshot('020_otp.png')
            driver.find_element("[title=code]").send_keys(pyotp.TOTP(totp_secret).now())

        driver.wait_for_element(".user-profile")
        print(driver.get_cookie('b_t_c_k')['value'])

    except:
        print('')

    finally:
        driver.save_screenshot('030_finally.png')
        driver.close()
        driver.quit()

main()
